import { useState, useCallback, useEffect } from 'react';
import { generateUUID } from '@/lib/uuid';
import useLocalStorageState from '@/hooks/useLocalStorageState';
import { UNIFIED_IMAGE_MODELS, UnifiedImageModel } from '@/config/unified-image-models';

// Type definitions for Studio Parameters
export type StudioParams = {
    // Common
    seed?: number;
    steps?: number;
    guidance_scale?: number;
    negative_prompt?: string;
    output_quality?: number;
    output_format?: 'webp' | 'jpg' | 'png' | 'mp4';
    
    // Pollinations Specific
    enhance?: boolean;
    nologo?: boolean;
    private?: boolean;
    safe?: boolean;
    
    // Replicate / Flux Specific
    safety_tolerance?: number;
    interval?: number;
    
    // Video Specific
    duration?: number;
    fps?: number;
    aspect_ratio?: string;
    
    // Dynamic fallback for new model features
    [key: string]: any;
};

export type StudioState = {
    // Core
    prompt: string;
    setPrompt: (p: string) => void;
    selectedModelId: string;
    setSelectedModelId: (id: string) => void;
    
    // Dimensions
    width: number;
    setWidth: (w: number) => void;
    height: number;
    setHeight: (h: number) => void;
    
    // Advanced Params
    params: StudioParams;
    setParams: (p: StudioParams | ((prev: StudioParams) => StudioParams)) => void;
    updateParam: (key: keyof StudioParams, value: any) => void;
    
    // Inputs
    uploadedImages: string[];
    setUploadedImages: (imgs: string[]) => void;
    
    // Helpers
    currentModel: UnifiedImageModel | undefined;
    resetParams: () => void;
};

const DEFAULT_PARAMS: StudioParams = {
    seed: undefined, // Random
    steps: 25,
    guidance_scale: 3.0,
    output_quality: 100,
    output_format: 'webp',
    enhance: false,
    nologo: true,
    private: true,
    safe: false,
};

export function useStudioState(): StudioState {
    // Persistent State for the Studio
    const [prompt, setPrompt] = useLocalStorageState<string>('studio-prompt', '');
    const [selectedModelId, setSelectedModelId] = useLocalStorageState<string>('studio-model', 'flux');
    
    // Dimensions (Standard defaults)
    const [width, setWidth] = useLocalStorageState<number>('studio-width', 1024);
    const [height, setHeight] = useLocalStorageState<number>('studio-height', 1024);
    
    // Advanced Parameters
    const [params, setParams] = useLocalStorageState<StudioParams>('studio-params', DEFAULT_PARAMS);
    
    // Uploaded Images
    const [uploadedImages, setUploadedImages] = useState<string[]>([]);

    const POLLINATIONS_ONLY = UNIFIED_IMAGE_MODELS.filter(m => m.provider === 'pollinations');
    const currentModel = POLLINATIONS_ONLY.find(m => m.id === selectedModelId);

    const updateParam = useCallback((key: keyof StudioParams, value: any) => {
        setParams(prev => ({ ...prev, [key]: value }));
    }, [setParams]);

    const resetParams = useCallback(() => {
        setParams(DEFAULT_PARAMS);
        setWidth(1024);
        setHeight(1024);
    }, [setParams, setWidth, setHeight]);

    // Ensure we are always on a pollinations model
    useEffect(() => {
        if (currentModel?.provider !== 'pollinations' && POLLINATIONS_ONLY.length > 0) {
            setSelectedModelId('flux');
        }
    }, [selectedModelId, currentModel, POLLINATIONS_ONLY, setSelectedModelId]);

    return {
        prompt,
        setPrompt,
        selectedModelId,
        setSelectedModelId,
        width,
        setWidth,
        height,
        setHeight,
        params,
        setParams,
        updateParam,
        uploadedImages,
        setUploadedImages,
        currentModel,
        resetParams
    };
}
